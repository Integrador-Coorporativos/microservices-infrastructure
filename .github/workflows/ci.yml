---
name: CI Pipeline

on:
  push:
    branches: ["main", "develop"]
  pull_request:
    branches: ["main", "develop"]

jobs:
  validate:
    name: Validate YAML and docker-compose
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        
      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y docker-compose yamllint

      - name: Validate YAML files (não trava CI)
        run: yamllint . || echo "⚠️ yamllint encontrou problemas, mas o CI continua."

      - name: Validate docker-compose
        run: docker-compose -f docker-compose.local.yml config || echo "⚠️ docker-compose config encontrou problemas, mas o CI continua."

  infra_and_tests:
    name: Setup Infrastructure & Run Tests
    runs-on: ubuntu-latest
    needs: validate

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Clone private services
        run: |
          mkdir -p services
          git clone https://$GH_TOKEN@github.com/Integrador-Coorporativos/import_and_report_service.git services/import_and_report_service
          git clone https://$GH_TOKEN@github.com/Integrador-Coorporativos/academic_service.git services/academic_service
        env:
          GH_TOKEN: ${{ secrets.GH_TOKEN }}

      - name: Install PowerShell
        run: |
          sudo apt-get update
          sudo apt-get install -y wget apt-transport-https software-properties-common
          wget -q https://packages.microsoft.com/config/ubuntu/22.04/packages-microsoft-prod.deb
          sudo dpkg -i packages-microsoft-prod.deb
          sudo apt-get update
          sudo apt-get install -y powershell
          
      - name: Create Docker network
        run: docker network create infra || echo "Network already exists"

      - name: Start infrastructure (Linux)
        run: |
          chmod +x ./up.ps1
          pwsh ./up.ps1 --build

      - name: Wait for services to start
        run: sleep 60

      - name: Run infrastructure checks
        run: |
          chmod +x ./tests/check-infra.sh
          ./tests/check-infra.sh


      - name: Upload test report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-reports
          path: test-reports/


# 2. Job de Build e Push para o Amazon ECR
  build_and_push:
    name: Build & Push to ECR
    runs-on: ubuntu-latest
    needs: infra_and_tests
    if: github.ref == 'refs/heads/main'
    steps:
      - uses: actions/checkout@v4
      
      # Clone dos serviços privados (necessário para o build)
      - name: Clone private services
        run: |
          mkdir -p services
          git clone https://${{ secrets.GH_TOKEN }}@github.com/Integrador-Coorporativos/import_and_report_service.git services/import_and_report_service
          git clone https://${{ secrets.GH_TOKEN }}@github.com/Integrador-Coorporativos/academic_service.git services/academic_service

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ secrets.AWS_REGION }}

      - name: Login to Amazon ECR
        id: login-ecr
        uses: aws-actions/amazon-ecr-login@v2

      - name: Build and Push Images
        env:
          ECR_REGISTRY: ${{ steps.login-ecr.outputs.registry }}
        run: |
          # Build & Push Academic Service
          docker build -t $ECR_REGISTRY/academic_service:latest ./services/academic_service
          docker push $ECR_REGISTRY/academic_service:latest
          
          # Build & Push Import/Report Service
          docker build -t $ECR_REGISTRY/import_and_report_service:latest ./services/import_and_report_service
          docker push $ECR_REGISTRY/import_and_report_service:latest


  security_scan:
    name: Security Scan (Trivy)
    runs-on: ubuntu-latest
    needs: build_and_push

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install Trivy
        uses: aquasecurity/trivy-action@master

      - name: Scan Docker images
        run: |
          docker images | grep "app-" || echo "Nenhuma imagem encontrada para scan."
          for img in $(docker images --format "{{.Repository}}:{{.Tag}}" | grep "^app-"); do
            echo "Scanning $img"
            trivy image "$img"
          done

  # 3. Job de Deploy no EC2
  deploy:
    name: Deploy to EC2 (Amazon Linux 2023)
    runs-on: ubuntu-latest
    needs: [build_and_push, security_scan]
    steps:
      - name: Deploy via SSH
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USERNAME }}
          key: ${{ secrets.EC2_SSH_KEY }}
          # Passamos as variáveis de ambiente para o script remoto
          envs: GITHUB_SHA
          script: |
            # Login no ECR dentro do servidor
            aws ecr get-login-password --region ${{ secrets.AWS_REGION }} | docker login --username AWS --password-stdin ${{ secrets.ECR_REGISTRY }}

            # Entrar na pasta do projeto (ajuste se necessário)
            cd ~/if-performance

            # Atualizar o arquivo .env dinamicamente com os segredos do GitHub
            cat > .env << EOL
            # Infra
            ECR_REGISTRY=${{ secrets.ECR_REGISTRY }}
            AWS_REGION=${{ secrets.AWS_REGION }}
            
            # Keycloak
            KC_DB_USERNAME=${{ secrets.KC_DB_USERNAME }}
            KC_DB_PASSWORD=${{ secrets.KC_DB_PASSWORD }}
            KEYCLOAK_ADMIN_USER=${{ secrets.KEYCLOAK_ADMIN_USER }}
            KEYCLOAK_ADMIN_PASSWORD=${{ secrets.KEYCLOAK_ADMIN_PASSWORD }}
            KEYCLOAK_CLIENT_SECRET=${{ secrets.KEYCLOAK_CLIENT_SECRET }}
            KEYCLOAK_SERVER_URL=${{ secrets.KEYCLOAK_SERVER_URL }}
            KEYCLOAK_REALM=${{ secrets.KEYCLOAK_REALM }}
            KEYCLOAK_CLIENT_ID=${{ secrets.KEYCLOAK_CLIENT_ID }}

            # Database & Services
            SPRING_DATASOURCE_URL=${{ secrets.SPRING_DATASOURCE_URL }}
            SPRING_DATASOURCE_USERNAME=${{ secrets.SPRING_DATASOURCE_USERNAME }}
            SPRING_DATASOURCE_PASSWORD=${{ secrets.SPRING_DATASOURCE_PASSWORD }}
            
            # Rabbit & Redis
            RABBITMQ_USERNAME=${{ secrets.RABBITMQ_USERNAME }}
            RABBITMQ_PASSWORD=${{ secrets.RABBITMQ_PASSWORD }}
            REDIS_HOST=redis-local
            
            # Minio
            MINIO_ROOT_USER=${{ secrets.MINIO_ROOT_USER }}
            MINIO_ROOT_PASSWORD=${{ secrets.MINIO_ROOT_PASSWORD }}
            EOL

            # No Amazon Linux 2023 o comando é 'docker compose'
            docker compose -f docker-compose.prod.yml pull
            docker compose -f docker-compose.prod.yml up -d
            
            # Limpeza de imagens antigas para não encher o disco
            docker image prune -af