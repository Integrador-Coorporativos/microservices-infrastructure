---
name: CI Pipeline

on:
  push:
    branches: ["main"]
  pull_request:
    branches: ["main"]

jobs:
  validate:
    name: Validate YAML and docker-compose
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        
      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y docker-compose yamllint

      - name: Validate YAML files (não trava CI)
        run: yamllint . || echo "⚠️ yamllint encontrou problemas, mas o CI continua."

      - name: Validate docker-compose
        run: docker-compose -f docker-compose.local.yml config || echo "⚠️ docker-compose config encontrou problemas, mas o CI continua."

  infra_and_tests:
    name: Setup Infrastructure & Run Tests
    runs-on: ubuntu-latest
    needs: validate

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Clone private services
        run: |
          mkdir -p services
          git clone https://$GH_TOKEN@github.com/Integrador-Coorporativos/import_and_report_service.git services/import_and_report_service
          git clone https://$GH_TOKEN@github.com/Integrador-Coorporativos/academic_service.git services/academic_service
        env:
          GH_TOKEN: ${{ secrets.GH_TOKEN }}

      - name: Install PowerShell
        run: |
          sudo apt-get update
          sudo apt-get install -y wget apt-transport-https software-properties-common
          wget -q https://packages.microsoft.com/config/ubuntu/22.04/packages-microsoft-prod.deb
          sudo dpkg -i packages-microsoft-prod.deb
          sudo apt-get update
          sudo apt-get install -y powershell
          
      - name: Create Docker network
        run: docker network create infra || echo "Network already exists"

      - name: Start infrastructure (Linux)
        run: |
          chmod +x ./up.ps1
          pwsh ./up.ps1 --build

      - name: Wait for services to start
        run: sleep 60

      - name: Run infrastructure checks
        run: |
          chmod +x ./tests/check-infra.sh
          ./tests/check-infra.sh


      - name: Upload test report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-reports
          path: test-reports/


  build_and_push:
      name: Build, Scan & Push to Docker Hub
      runs-on: ubuntu-latest
      if: github.ref == 'refs/heads/main'
      steps:
        - uses: actions/checkout@v4

        - name: Clone private services
          run: |
            mkdir -p services
            git clone https://${{ secrets.GH_TOKEN }}@github.com/Integrador-Coorporativos/import_and_report_service.git services/import_and_report_service
            git clone https://${{ secrets.GH_TOKEN }}@github.com/Integrador-Coorporativos/academic_service.git services/academic_service

        - name: Login to Docker Hub
          uses: docker/login-action@v3
          with:
            username: ${{ secrets.DOCKERHUB_USERNAME }}
            password: ${{ secrets.DOCKERHUB_TOKEN }}

        - name: Install Trivy
          run: curl -sfL https://raw.githubusercontent.com/aquasecurity/trivy/main/contrib/install.sh | sh -s -- -b /usr/local/bin

        - name: Build, Scan & Push Academic Service
          run: |
            # Formato no Docker Hub: usuario/repositorio:tag
            IMAGE_NAME=${{ secrets.DOCKERHUB_USERNAME }}/academic_service:latest
            docker build -t $IMAGE_NAME ./services/academic_service
            trivy image --exit-code 1 --severity CRITICAL $IMAGE_NAME
            docker push $IMAGE_NAME

        - name: Build, Scan & Push Import Service
          run: |
            IMAGE_NAME=${{ secrets.DOCKERHUB_USERNAME }}/import_and_report_service:latest
            docker build -t $IMAGE_NAME ./services/import_and_report_service
            trivy image --exit-code 1 --severity CRITICAL $IMAGE_NAME
            docker push $IMAGE_NAME

  # 3. Job de Deploy no EC2
  deploy:
    name: Deploy to EC2 (Amazon Linux 2023)
    runs-on: ubuntu-latest
    needs: build_and_push
    steps:
      - name: Deploy via SSH
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.OVH_IP }}
          username: ${{ secrets.OVH_USERNAME }}
          key: ${{ secrets.OVH_PASSWORD }}
          # Passamos as variáveis de ambiente para o script remoto
          envs: GITHUB_SHA
          script: |

            # Entrar na pasta do projeto (ajuste se necessário)
            cd ~/microservices-infrastructure

            # Atualizar o arquivo .env dinamicamente com os segredos do GitHub
            cat > .env << EOL
            # Infra
            ECR_REGISTRY=${{ secrets.ECR_REGISTRY }}
            AWS_REGION=${{ secrets.AWS_REGION }}
            
            # Keycloak
            KC_DB_USERNAME=${{ secrets.KC_DB_USERNAME }}
            KC_DB_PASSWORD=${{ secrets.KC_DB_PASSWORD }}
            KEYCLOAK_ADMIN_USER=${{ secrets.KEYCLOAK_ADMIN_USER }}
            KEYCLOAK_ADMIN_PASSWORD=${{ secrets.KEYCLOAK_ADMIN_PASSWORD }}
            KEYCLOAK_CLIENT_SECRET=${{ secrets.KEYCLOAK_CLIENT_SECRET }}
            KEYCLOAK_SERVER_URL=${{ secrets.KEYCLOAK_SERVER_URL }}
            KEYCLOAK_REALM=${{ secrets.KEYCLOAK_REALM }}
            KEYCLOAK_CLIENT_ID=${{ secrets.KEYCLOAK_CLIENT_ID }}

            # Database & Services
            SPRING_DATASOURCE_URL=${{ secrets.SPRING_DATASOURCE_URL }}
            SPRING_DATASOURCE_USERNAME=${{ secrets.SPRING_DATASOURCE_USERNAME }}
            SPRING_DATASOURCE_PASSWORD=${{ secrets.SPRING_DATASOURCE_PASSWORD }}
            
            # Rabbit & Redis
            RABBITMQ_USERNAME=${{ secrets.RABBITMQ_USERNAME }}
            RABBITMQ_PASSWORD=${{ secrets.RABBITMQ_PASSWORD }}
            REDIS_HOST=redis-local
            
            # Minio
            MINIO_ROOT_USER=${{ secrets.MINIO_ROOT_USER }}
            MINIO_ROOT_PASSWORD=${{ secrets.MINIO_ROOT_PASSWORD }}

            DOCKERHUB_USERNAME=${{ secrets.DOCKERHUB_USERNAME }}
            EOL

            git restore up.ps1
            git pull origin main
            
            chmod +x ./up.ps1
            pwsh ./up.ps1 -Prod -Build
            
            # Limpeza de imagens antigas para não encher o disco
            docker image prune -af
